{% extends "base.html" %}

{% block title %}NOA Beauty — новый чек{% endblock %}

{% block extra_head %}
    <style>
        h1 { margin-bottom: 16px; }
        .basket-row { background: #f7fbfc; border:1px solid #def; border-radius: 8px; padding: 16px 14px 10px 14px; margin-bottom: 15px; box-shadow:0 2px 7px #e9eff2; position:relative; }
        .pos-number { position:absolute; left:-14px; top:12px; color:#888; font-weight:bold; font-size:1.12em; }
        .fields-grid { display: grid; grid-template-columns: 138px 1fr 1fr; gap: 12px; align-items: end; }
        .row-label { min-width:117px;font-weight: 500; margin-top:8px; }
        select, input[type=number], input[type=text] { font-size: 1.03em; padding: 7px 8px; border-radius:4px; border:1px solid #bbc; width:98%; background:#fff; margin-bottom:2px; }
        .field-group {margin-bottom:7px;}
        .remove-btn { background: #e54234; color: #fff; border:none; font-size:1.22em; padding:3px 13px; border-radius: 5px; cursor:pointer; margin-left:12px; float:right; }
        .add-btn { background: #2698ed; color:#fff; font-size:1.07em; border-radius:6px; border:none; padding:10px 19px; margin-top:14px; cursor:pointer; font-weight:600;}
        .summary { font-size:1.16em; margin:22px 0 10px; font-weight:bold; color:#242e5d; }
        .sumline { margin-top:2px; }
        .error { color:#c10404; margin-bottom:13px; }
        button[type=submit] { font-size:1.12em; padding: 11px 32px; background: #28b027; color: #fff; border: none; border-radius:6px; margin-top: 18px; font-weight:600; }
        .note { color: #555; font-size: 0.97em; margin-top: 28px;}
        a { color: #296080; }
        .summary-total { color: #28882a; font-weight:bold; font-size: 1.18em; }
        .summary-discount, .sumline-discount { color:#d72233; font-weight:700; }
        .ost-label { font-size:.93em; color:#338; margin-left:6px; }
        .tara-price { font-size:.98em; color:#2b4; margin-left:0.7em; font-weight:500; } .tara-free { color:#888; }
        .product-search-input { font-size: 0.9em; padding: 4px 8px; border-radius: 4px; border: 1px solid #ccd; width: 98%; margin-bottom: 4px; }
        .product-search-input::placeholder { color: #999; }
    </style>
{% endblock %}

{% block extra_js %}
    <script>
        
    let productOptions = {};
    let productStock = {};
    let cosmeticOptions = {};
    let cosmeticStock = {};
    let bottleOptions = {};
    {% for p in perfumes %}productOptions[{{p.id}}] = {price_ml: {{p.price_per_ml}}, price_bottle: {{p.full_bottle_price}}, bottle_ml: {{p.bottle_volume_ml}}, name: "{{p.brand}} {{p.name}}"}; productStock[{{p.id}}] = 999; /* TODO: заменить на фактический остаток */
    {% endfor %}
    {% for c in cosmetics %}cosmeticOptions[{{c.id}}] = {price: {{c.unit_price}}, name: "{{c.brand}} {{c.name}}"}; cosmeticStock[{{c.id}}] = null;
    {% endfor %}
    {% for b in bottles %}bottleOptions[{{b.id}}] = {price: {{b.price}}, volume_ml: {{b.volume_ml}}, name: "{{b.name}}", is_paid: {{b.is_paid|yesno:'1,0'}}, label: "{{b.name}} {{b.volume_ml}} мл{% if b.is_paid %} ({{b.price}} сом){% else %} (бесплатно){% endif %}"};
    {% endfor %}
    function addRow() {
      const container = document.getElementById('basket');
      let idx = container.children.length+1;
      let d = document.createElement('div');
      d.className = 'basket-row';
      d.innerHTML = `
        <div class='pos-number'>#${idx}</div>
        <div class='fields-grid'>
         <div class='field-group'>
           <label class='row-label'>Тип товара*</label>
           <select name="item_type" class="itm-type" onchange="onTypeChange(this)">
             <option value="split">Распив (по мл)</option>
             <option value="full">Флакон полностью</option>
             <option value="cosmetic">Косметика</option>
           </select>
         </div>
         <div class='field-group perfume-gr'>
           <label class='row-label'>Парфюм</label>
           <input type="text"
                  class="product-search-input perfume-search"
                  placeholder="Поиск по названию, бренду или штрихкоду"
                  oninput="filterPerfumeOptions(this)" />
           <select name="perfume" class="perfume" onchange="onPerfumeChange(this)">
              <option value="">-- Выберите парфюм --</option>
              {% for p in perfumes %}
                  <option value="{{p.id}}">
                      {{p.brand}} {{p.name}}{% if p.barcode %} — {{p.barcode}}{% endif %}
                  </option>
              {% endfor %}
           </select>
           <span class='ost-label perfume-ost' style='display:none'>остаток: n/a</span>
         </div>
         <div class='field-group cosmetic-gr' style='display:none'>
           <label class='row-label'>Косметика</label>
           <input type="text"
                  class="product-search-input cosmetic-search"
                  placeholder="Поиск по названию, бренду или штрихкоду"
                  oninput="filterCosmeticOptions(this)" />
           <select name="cosmetic" class="cosmetic" onchange="onCosmeticChange(this)">
             <option value="">-- Выберите косметику --</option>
             {% for c in cosmetics %}
                 <option value="{{c.id}}">
                     {{c.brand}} {{c.name}}{% if c.barcode %} — {{c.barcode}}{% endif %}
                 </option>
             {% endfor %}
           </select>
           <span class='ost-label cosmetic-ost' style='display:none'>остаток: n/a</span>
         </div>
         <div class='field-group ml-group'>
           <label class='row-label'>Распив, мл</label>
           <input name="ml_qty" class="ml_qty" type="number" min="0" step="0.1" placeholder="Сколько мл" />
         </div>
         <div class='field-group bottle-group' style="display:none">
           <label class='row-label'>Флаконов/Шт.*</label>
           <input name="bottle_qty" class="bottle_qty" type="number" min="0" step="1" placeholder="Сколько шт"/>
         </div>
         <div class='field-group tara-group' style="display:none">
           <label class='row-label'>Тип атомайзера</label>
           <select name="bottle_type" class="bottle_type" onchange="onTaraChange(this)">
              <option value="">-- Тип атомайзера --</option>
              {% for b in bottles %}<option value="{{b.id}}">{{b.name}} {{b.volume_ml}} мл{% if b.is_paid %} ({{b.price}} сом){% else %} (бесплатно){% endif %}</option>{% endfor %}
           </select>
           <span class="tara-price" style="display:none;"></span>
         </div>
         <div class='field-group tara-qty-group' style="display:none">
           <label class='row-label'>Кол-во атомайзеров</label>
           <input name="atomizer_qty" class="atomizer_qty" type="number" min="0" step="1" placeholder="Сколько шт" value="1"/>
         </div>
         <div class='field-group'>
           <label class='row-label'>Цена, сом</label>
           <input name="price" class="price" type="number" min="0" placeholder="Цена автоматически" readonly />
         </div>
         <div class='field-group'>
           <label class='row-label'>Скидка на товар, сом</label>
           <input name="item_discount" class="item_discount" type="number" min="0" value="0" placeholder="0" />
         </div>
         <div class='field-group'>
           <button type="button" class="remove-btn" onclick="this.closest('.basket-row').remove(); updatePositionNumbers(); summaryUpdate();" title='Удалить позицию'>–</button>
         </div>
        </div>
      `;
      container.appendChild(d);
      summaryUpdate();
    }
    function onTypeChange(sel) {
      let row = sel.closest('.basket-row');
      let type = sel.value;
      row.querySelector('.perfume-gr').style.display = (type !== 'cosmetic') ? '' : 'none';
      row.querySelector('.cosmetic-gr').style.display = (type === 'cosmetic') ? '' : 'none';
      row.querySelector('.ml-group').style.display = (type === 'split') ? '' : 'none';
      row.querySelector('.bottle-group').style.display = (type !== 'split') ? '' : 'none';
      row.querySelector('.tara-group').style.display = (type === 'split') ? '' : 'none';
      row.querySelector('.tara-qty-group').style.display = (type === 'split') ? '' : 'none';
      summaryUpdate();
    }
    function filterPerfumeOptions(input) {
      const row = input.closest('.basket-row');
      const select = row.querySelector('select.perfume');
      const term = input.value.toLowerCase().trim();
      if (!term) {
        // если поле очистили — сбрасываем выбор
        select.value = "";
        onPerfumeChange(select);
        return;
      }
      let firstMatch = null;
      const options = Array.from(select.options);
      for (let opt of options) {
        if (!opt.value) continue;  // пропускаем placeholder
        const text = opt.textContent.toLowerCase();
        if (text.includes(term)) {
          firstMatch = opt.value;
          break;
        }
      }
      if (firstMatch) {
        select.value = firstMatch;
        onPerfumeChange(select);
      }
    }
    function onPerfumeChange(sel) {
      let row = sel.closest('.basket-row');
      let type = row.querySelector('.itm-type').value;
      let perfumeId = sel.value;
      let ostSpan = row.querySelector('.perfume-ost');
      if (perfumeId) {
        ostSpan.innerText = 'остаток: '+(productStock[perfumeId]||'нет');
        ostSpan.style.display = '';
      } else {
        ostSpan.style.display = 'none';
      }
      if (perfumeId && type === "split") {
        row.querySelector('.price').value = productOptions[perfumeId]['price_ml'];
      }
      if (perfumeId && type === "full") {
        row.querySelector('.price').value = productOptions[perfumeId]['price_bottle'];
      }
      summaryUpdate();
    }
    function onTaraChange(sel) {
      let row = sel.closest('.basket-row');
      let btlId = sel.value;
      let lbl = row.querySelector('.tara-price');
      if (btlId && bottleOptions[btlId]) {
        if(bottleOptions[btlId].is_paid) lbl.innerText = 'Платная тара: '+bottleOptions[btlId].price+' сом/шт.';
        else lbl.innerText = 'Бесплатная тара';
        lbl.style.display = '';
      } else {
        lbl.style.display = 'none';
      }
      summaryUpdate();
    }
    function filterCosmeticOptions(input) {
      const row = input.closest('.basket-row');
      const select = row.querySelector('select.cosmetic');
      const term = input.value.toLowerCase().trim();
      if (!term) {
        select.value = "";
        onCosmeticChange(select);
        return;
      }
      let firstMatch = null;
      const options = Array.from(select.options);
      for (let opt of options) {
        if (!opt.value) continue;
        const text = opt.textContent.toLowerCase();
        if (text.includes(term)) {
          firstMatch = opt.value;
          break;
        }
      }
      if (firstMatch) {
        select.value = firstMatch;
        onCosmeticChange(select);
      }
    }
    function onCosmeticChange(sel) {
      let row = sel.closest('.basket-row');
      let cosmeticId = sel.value;
      let ostSpan = row.querySelector('.cosmetic-ost');
      if (cosmeticId) {
        ostSpan.innerText = 'остаток: '+(cosmeticStock[cosmeticId]||'нет');
        ostSpan.style.display = '';
      } else {
        ostSpan.style.display = 'none';
      }
      if (cosmeticId) {
        row.querySelector('.price').value = cosmeticOptions[cosmeticId]['price'];
      }
      summaryUpdate();
    }
    function summaryUpdate() {
      let rows = document.querySelectorAll('#basket .basket-row');
      let total = 0, discount = 0;
      for (let row of rows) {
        let type = row.querySelector('.itm-type').value;
        let price = +row.querySelector('.price').value || 0;
        let item_discount = +row.querySelector('.item_discount').value || 0;
        let tara_sum = 0;
        if(type == 'split') {
          let tara_id = row.querySelector('.bottle_type').value;
          let atomizer_qty = +row.querySelector('.atomizer_qty').value || 0;
          if (tara_id && bottleOptions[tara_id] && atomizer_qty > 0) {
            tara_sum = bottleOptions[tara_id].is_paid ? bottleOptions[tara_id].price * atomizer_qty : 0;
          }
        }
        let qty = 1;
        if (type == 'split') qty = +row.querySelector('.ml_qty').value || 0;
        else if (type == 'cosmetic') qty = +row.querySelector('.bottle_qty').value || 0;
        else if (type == 'full') qty = +row.querySelector('.bottle_qty').value || 0;
        let sum = price * qty + tara_sum - item_discount;
        if (sum < 0) sum = 0;
        total += sum;
        discount += item_discount;
        row.querySelector('.item_discount').style.background = (sum === 0 && (price*qty+tara_sum)>0)?'#ffb5b2':'';
      }
      document.getElementById('summary_total').innerText = total;
      document.getElementById('summary_discount').innerText = discount;
    }
    function updatePositionNumbers() {
      let positions = document.querySelectorAll('.basket-row .pos-number');
      let i = 1;
      for (let n of positions) n.innerText = '#' + (i++);
    }
    window.onload = function(){
      addRow();
    }
    </script>
{% endblock %}

{% block page_header %}
    <h1 class="h4 mb-1">Пробить новый чек</h1>
    <p class="text-muted mb-0">Добавьте позиции распива, полных флаконов и косметики</p>
{% endblock %}

{% block content %}
    <h1>Пробить новый чек</h1>
    {% if error %}<div class="error">{{ error }}</div>{% endif %}
    <form method="post">
        {% csrf_token %}
        <div id="basket"></div>
        <button type="button" class="add-btn" onclick="addRow()">+ Добавить товар/позицию</button>
        <label class="row-label">Тип оплаты</label>
        </div>
        <select name="payment_method" required>
          <option value="">— выберите —</option>
          {% for method in payment_methods %}
              <option value="{{ method.id }}">{{ method.name }}</option>
          {% endfor %}
      </select>
        <div class="field-group">
          <label for="sale_discount">Скидка на чек (дополнительно, сом)</label>
          <input type="number" min="0" value="0" name="sale_discount" id="sale_discount"/>
        </div>
        <button type="submit">Пробить и сохранить чек</button>
    </form>
    <p class="note">Можно добавить несколько товаров — чек с множеством позиций. Итоги и скидки считаются автоматически. <a href="/sales/today/">К списку продаж</a></p>
{% endblock %}

