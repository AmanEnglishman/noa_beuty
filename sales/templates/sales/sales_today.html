{% extends "base.html" %}

{% block title %}
NOA Beauty ‚Äî –ø—Ä–æ–¥–∞–∂–∏ –∑–∞ {{ today }}
{% endblock %}

{% block page_header %}
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <h2 class="h4 mb-1">–ü—Ä–æ–¥–∞–∂–∏ –∑–∞ {{ today }}</h2>
            <p class="text-muted mb-0">–°–ø–∏—Å–æ–∫ —á–µ–∫–æ–≤ –∏ –ø–æ–∑–∏—Ü–∏–π –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å</p>
        </div>
        <div class="text-end">
            <div class="fs-5 fw-bold text-success">
                –ò—Ç–æ–≥–æ –∑–∞ –¥–µ–Ω—å: {{ total_today|floatformat:0 }} —Å–æ–º
            </div>
            <div class="text-muted small">
                –ß–µ–∫–æ–≤: {{ sales|length }}
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
    {% if not sales %}
        <p class="text-muted mb-0">–ù–µ—Ç –ø—Ä–æ–¥–∞–∂ –∑–∞ —Å–µ–≥–æ–¥–Ω—è.</p>
    {% endif %}

    {% for sale in sales %}
        <div class="mb-3 border rounded-3 p-3" id="sale-{{ sale.id }}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <h3 class="h6 mb-0">–ß–µ–∫ ‚Ññ{{ sale.id }}</h3>
                    <span class="text-muted small">
                        –í—Ä–µ–º—è: {{ sale.sale_date|date:"H:i" }}
                        |
                        –û–ø–ª–∞—Ç–∞:
                        <strong>{{ sale.payment_method.name }}</strong>
                    </span>
                </div>
            </div>

            <div class="table-responsive mb-2">
                <table class="table table-sm table-striped align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>–¢–∏–ø</th>
                            <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                            <th>–ú–ª./—à—Ç.</th>
                            <th>–ê—Ç–æ–º–∞–π–∑–µ—Ä</th>
                            <th>–°–∫–∏–¥–∫–∞</th>
                            <th>–°—É–º–º–∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in sale.items.all %}
                            <tr>
                                <td>{{ item.get_sale_type_display }}</td>
                                <td>
                                    {% if item.perfume %}
                                        {{ item.perfume }}
                                    {% elif item.cosmetic %}
                                        {{ item.cosmetic }}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.ml %}
                                        {{ item.ml }} –º–ª
                                    {% endif %}
                                    {% if item.bottles_count %}
                                        {{ item.bottles_count }} —Ñ–ª.
                                    {% endif %}
                                    {% if item.sale_type == 'split' and item.bottle_count %}
                                        {{ item.bottle_count }} –∞—Ç–æ–º–∞–π–∑–µ—Ä(–æ–≤)
                                    {% elif item.sale_type == 'cosmetic' and item.bottle_count %}
                                        {{ item.bottle_count }} —à—Ç.
                                    {% elif item.sale_type == 'gift' %}
                                        {% if item.ml %}{{ item.ml }} –º–ª{% endif %}
                                        {% if item.bottles_count %}{{ item.bottles_count }} —Ñ–ª.{% endif %}
                                        {% if item.bottle_count and item.cosmetic %}{{ item.bottle_count }} —à—Ç.{% endif %}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.bottle_type %}
                                        {{ item.bottle_type }}
                                    {% endif %}
                                </td>
                                <td class="text-danger fw-semibold">
                                    {{ item.discount_percent }} %
                                </td>
                                <td class="fw-semibold">
                                    {% if item.sale_type == 'gift' %}
                                        <span class="text-success">–ü–æ–¥–∞—Ä–æ–∫ (0 —Å–æ–º)</span>
                                    {% else %}
                                        {{ item.line_total }} —Å–æ–º
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-between align-items-center">
                <button
                    class="btn btn-sm btn-outline-primary"
                    id="print-btn-{{ sale.id }}"
                    onclick="printSale({{ sale.id }})">
                    üñ® –ü–µ—á–∞—Ç—å
                </button>

                <span class="fw-bold">
                    –ò—Ç–æ–≥–æ: {{ sale.total }} —Å–æ–º
                </span>
            </div>
        </div>
    {% endfor %}

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function printSale(saleId) {
            const btn = document.getElementById(`print-btn-${saleId}`);
            btn.disabled = true;
            btn.innerText = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...";

            fetch(`/sales/print/${saleId}/`, {
                method: "POST",
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": getCookie("csrftoken"),
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("HTTP " + response.status);
                }
                btn.innerText = "‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ";
            })
            .catch(error => {
                console.error(error);
                btn.disabled = false;
                btn.innerText = "‚ùå –û—à–∏–±–∫–∞";
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —á–µ–∫–∞ –Ω–∞ –ø–µ—á–∞—Ç—å");
            });
        }
    </script>
{% endblock %}
